# This OpenOCD script can be used for debugging the non-secure GPLv3 part of
# the firmware running on ZuluIDE-RP2350.

set USE_CORE 0

source [find target/rp2350.cfg]

rp2350.dap.core0 configure -event examine-start {
    set cswval [rp2350.dap apreg 0x2000 0xd00]

    if {[expr {$cswval & 0x800000}]} {
        echo "Secure debug mode"
        rp2350.dap apsel 0x2000
        rp2350.dap apcsw 0xa2000000
    } else {
        echo "Non-secure debug mode"
        rp2350.dap apsel 0x2000
        rp2350.dap apcsw 0x43000000
    }
}

rp2350.dap.core0 configure -event reset-assert {
}

rp2350.dap.core0 configure -event reset-assert-post {
    # Reset using watchdog reset (it works better with the trustzone)
    echo "Resetting using watchdog ctrl trigger"
    catch { mww 0x400d8000 0x80000000 }
    sleep 2000
    halt
}

rp2350.dap.core0 configure -event gdb-flash-erase-start {
    echo "Resetting to bootloader mode"
    mww 0x400d8028 0x70ADC0DE
    catch { mww 0x400d8000 0x80000000 }
    sleep 5000

    halt
}

